# Session Memory: 钉钉卡片

**Session**: 3fd6932f-5311-459b-8b97-e166fe9bfe66
**Branch**: main
**Date**: 2026-02-19 19:10
**Project**: /Users/layne/develop/ai/LobsterAI

## Key Discussions

- 实现钉钉 IM 机器人 AI Card（aicard）流式打字机效果回复
- 排查并修复 IMSettings.tsx 中「回复方式」切换按钮两个 bug：
  1. 点击按钮导致 Settings 模态意外关闭（表单提交问题）
  2. 点击按钮无法切换（React 闭包竞态问题）

## Decisions Made

- **AI Card 流式架构**：新建 `dingtalkAICard.ts` 模块，封装钉钉 AI Card 四步生命周期（创建/投递/流式更新/最终化）；失败时优雅降级为 Markdown
- **流式回调链路**：通过 `IMStreamCallbacks` 接口从 DingTalkGateway → IMGatewayManager → IMCoworkHandler 向上传递，800ms 节流
- **Bug 1 修复**：两个 `<button>` 补加 `type="button"` 防止触发父 `<form>` 提交
- **Bug 2 修复**：切换按钮 `onClick` 改为直接调用 `imService.updateConfig({ dingtalk: { ...config.dingtalk, messageType: newValue } })`，与 `toggleGateway` 模式对齐，绕过 `handleSaveConfig` 读取旧闭包值的竞态

## Open Issues

- 钉钉 AI Card 需要三项专用 API 权限（`card:instance:create`、`card:instance:delivery`、`card:streaming:update`），需在钉钉开放平台手动申请

## Action Items

1. 在钉钉开放平台为应用申请 AI Card 相关权限后，测试完整的端到端流式卡片效果
2. 可选：在 IMSettings.tsx 中为卡片模板 ID 添加说明链接

## Technical Context

- **React 闭包竞态**：`useSelector` 的 `config` 在 `dispatch()` 后、重渲染前仍是旧值；`handleSaveConfig` 依赖此闭包因此会保存旧值。解法：在 onClick 中手动构造含新值的对象直接传给服务层，不依赖 Redux state 更新
- **DingTalk AI Card API 端点**：
  - `POST /v1.0/card/instances/create` — 创建实例
  - `POST /v1.0/card/instances/deliver` — 投递到会话
  - `PUT /v1.0/card/streaming` — 流式更新（`flowStatus: "2"` = 输入中，`"3"` = 完成）
- `openSpaceId` 格式：DM = `dtv1.card//IM_ROBOT.{userId}`，群聊 = `dtv1.card//IM_GROUP.{openConversationId}`
- `outTrackId` 格式：`card_{timestamp}_{random6}`

## Code Changes This Session

| 文件 | 变更 |
|------|------|
| `src/main/im/dingtalkAICard.ts` | **新建**：5 个导出函数（generateOutTrackId / createCardInstance / deliverCardInstance / updateCardStreaming / finalizeCard） |
| `src/main/im/types.ts` | 新增 `IMStreamCallbacks` 接口 |
| `src/main/im/imCoworkHandler.ts` | `MessageAccumulator` 扩展流式字段；`processMessage` 接受可选 `onStreamingUpdate` 回调；`handleMessageUpdate` 节流触发回调 |
| `src/main/im/imGatewayManager.ts` | `messageHandler` 接受并传递 `streamCallbacks` |
| `src/main/im/dingtalkGateway.ts` | `handleInboundMessage` 新增 card 模式分支（创建/投递/流式/降级） |
| `src/renderer/components/im/IMSettings.tsx` | 添加「回复方式」切换 UI；Bug1: 加 `type="button"`；Bug2: onClick 改用 `imService.updateConfig` 直接传新值 |
